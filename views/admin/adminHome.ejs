<%- include('./partials/adminHeader') %>
<style>
    .button-container {
    display: flex;
    justify-content: center;
    gap: 10px;
}
</style>
<body>
    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="index.html" class="brand-wrap">
                <img src="/public/adminAsset/imgs/theme/eyetrek.png" class="logo" alt="Evara Dashboard">
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item active">
                    <a class="menu-link" href="/admin/adminHome"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/productList"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/orderPage"> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Orders</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/userManagement"> <i class="icon material-icons md-store"></i>
                        <span class="text">Users</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/categoryPage"> <i class="icon material-icons md-add_box"></i>
                        <span class="text">Category</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/offerPage"> <i class="icon material-icons md-add_box"></i>
                        <span class="text">Offers</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/couponPage"> <i class="icon material-icons md-add_box"></i>
                        <span class="text">Coupon</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/popularProductPage"> <i class="icon material-icons md-comment"></i>
                        <span class="text">Popular Products</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/bestCategoryPage"> <i class="icon material-icons md-pie_chart"></i>
                        <span class="text">Best Categories</span> </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" disabled href="/admin/topBrandPage"> <i class="icon material-icons md-stars"></i>
                        <span class="text">Top Brands</span>
                    </a>
                </li>
            </ul>
            <hr>
        </nav>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                <a class="dropdown-item text-danger" href="/admin/adminLogout"><i class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
        </header>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Dashboard </h2>
                    <p>Whole data about your business here</p>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-primary-light">
                                <i class="text-primary material-icons md-monetization_on"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Revenue</h6>
                                <span>â‚¹ <%= revenue.toFixed(2) %></span>
                                <span class="text-sm">
                                    Shipping fees are not included
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-success-light">
                                <i class="text-success material-icons md-local_shipping"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Orders</h6>
                                <span><%= totalOrders.toLocaleString() %></span>
                                <span class="text-sm">
                                    Excluding orders in transit
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-warning-light">
                                <i class="text-warning material-icons md-qr_code"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Products</h6>
                                <span><%= totalProducts.toLocaleString() %></span>
                                <span class="text-sm">
                                    In various categories
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-info-light">
                                <i class="text-info material-icons md-shopping_basket"></i>
                            </span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Users</h6>
                                <span><%= totalUsers.toLocaleString() %></span>
                                <span class="text-sm">
                                    Registered users
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
            </div>            
            <div class="row">
                <div class="col-xl-8 col-lg-12" style="margin-left: 16%;">
                    <div class="card mb-4">
                        <article class="card-body">
                            <h5 class="card-title">Sale statistics</h5>
                            <div class="button-container text-center">
                                <button onclick="updateChart('daily')" class="btn btn-primary mx-1">Daily</button>
                                <button onclick="updateChart('monthly')" class="btn btn-primary mx-1">Monthly</button>
                                <button onclick="updateChart('yearly')" class="btn btn-primary mx-1">Yearly</button>
                            </div>
                            <canvas id="myChart" height="120px"></canvas>
                        </article>
                    </div>
                    <script>
                        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        let myChart;
            
                        document.addEventListener('DOMContentLoaded', function () {
                            const ctx = document.getElementById('myChart').getContext('2d');
                            myChart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: [],
                                    datasets: [{
                                        label: 'Sales',
                                        backgroundColor: '#F94449',
                                        borderColor: '#088178',
                                        data: []
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: {
                                            labels: {
                                                usePointStyle: true,
                                            },
                                        }
                                    },
                                    scales: {
                                        x: {
                                            beginAtZero: true
                                        },
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
            
                            // Load initial chart data
                            updateChart('monthly');
                        });
            
                        async function fetchSalesData(filter) {
                            try {
                                const response = await fetch(`/admin/sales?filter=${filter}`);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                const data = await response.json();
                                return data;
                            } catch (error) {
                                console.error('Error fetching sales data:', error);
                            }
                        }
            
                        function updateChart(filter) {
                            if (!myChart) {
                                console.error('Chart is not initialized');
                                return;
                            }
            
                            fetchSalesData(filter).then(salesData => {
                                if (Array.isArray(salesData)) {
                                    let labels = [];
                                    let totals = [];
                                    const currentDate = new Date();
                                    const currentYear = currentDate.getFullYear();
                                    const currentMonth = currentDate.getMonth() + 1; // Months are zero-indexed
                                    const currentDay = currentDate.getDate();
            
                                    if (filter === "daily") {
                                        // Labels for current month days (1st to today's date)
                                        labels = Array.from({ length: currentDay }, (_, i) => i + 1);
                                        totals = Array(currentDay).fill(0);
                                        salesData.forEach(d => {
                                            if (d._id >= 1 && d._id <= currentDay) {
                                                totals[d._id - 1] = d.total;
                                            }
                                        });
                                    } else if (filter === "monthly") {
                                        // Labels for each month (Jan to current month)
                                        labels = monthNames.slice(0, currentMonth);
                                        totals = Array(currentMonth).fill(0);
                                        salesData.forEach(d => {
                                            if (d._id >= 1 && d._id <= currentMonth) {
                                                totals[d._id - 1] = d.total;
                                            }
                                        });
                                    } else if (filter === "yearly") {
                                        // Labels for each year until the current year
                                        labels = salesData.map(d => d._id);
                                        totals = salesData.map(d => d.total);
                                    }
            
                                    myChart.data.labels = labels;
                                    myChart.data.datasets[0].data = totals;
                                    myChart.update();
                                } else {
                                    console.error('Sales data is not an array:', salesData);
                                }
                            }).catch(error => console.error('Error updating chart:', error));
                        }
                    </script>
                </div>
            </div>                        
            <div class="card mb-4">
                <header class="card-header">
                    <h4 class="card-title">Sales Report</h4>
                    <div class="row align-items-center">
                        <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                            <div class="custom_select">
                                <select class="form-select select-nice" id="categoryFilter">
                                    <option selected value="">All Categories</option>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category.name %>"><%= category.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div class="col-md-2 col-6">
                            <input type="date" id="endDate" class="form-control">
                        </div>
                        <div class="col-md-2 col-6">
                            <div class="custom_select">
                                <select class="form-select select-nice" id="periodFilter">
                                    <option selected value="">Select Period</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-1 col-6">
                            <button class="btn btn-primary" onclick="fetchOrders()">Filter</button>
                        </div>
                    </div>
                </header>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle table-nowrap mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="text-center">
                                        <div class="form-check align-middle">
                                            <input class="form-check-input" type="checkbox" id="transactionCheck01">
                                            <label class="form-check-label" for="transactionCheck01"></label>
                                        </div>
                                    </th>
                                    <th class="align-middle" scope="col">Order ID</th>
                                    <th class="align-middle" scope="col">Billing Name</th>
                                    <th class="align-middle" scope="col">Date</th>
                                    <th class="align-middle" scope="col">Total</th>
                                    <th class="align-middle" scope="col">Payment Status</th>
                                    <th class="align-middle" scope="col">Payment Method</th>
                                    <th class="align-middle" scope="col">View Details</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="form-group">
                        <label for="reportFormat">Select Report Format</label>
                        <select id="reportFormat" class="form-control" style="width: 6.5%; border-color: black;">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="downloadReport()">Download Report</button>
                    <nav>
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be dynamically inserted here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </section> <!-- content-main end// -->
    </main>
    <script>
        async function fetchOrders(page = 1) {
            const category = document.getElementById('categoryFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const period = document.getElementById('periodFilter').value;
    
            const response = await fetch(`/admin/orders?page=${page}&category=${category}&startDate=${startDate}&endDate=${endDate}&period=${period}`);
            const data = await response.json();
    
            console.log('Fetched Orders Data:', data);
    
            const ordersTableBody = document.getElementById('ordersTableBody');
            ordersTableBody.innerHTML = '';
    
            data.orders.forEach(order => {
                ordersTableBody.innerHTML += `
                    <tr>
                        <td class="text-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="transactionCheck${order._id}">
                                <label class="form-check-label" for="transactionCheck${order._id}"></label>
                            </div>
                        </td>
                        <td><a href="#" class="fw-bold">#${order._id}</a></td>
                        <td>${order.userId ? order.userId.userName : 'Unknown'}</td>
                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td> ${order.totalPrice.toFixed(2)}</td>
                        <td>
                            <span class="badge badge-pill badge-soft-${order.paymentStatus === 'Paid' ? 'success' : (order.paymentStatus === 'Chargeback' ? 'danger' : 'warning')}">
                                ${order.paymentStatus}
                            </span>
                        </td>
                        <td>${order.paymentMethod}</td>
                        <td><a href="/admin/orders/${order._id}" class="btn btn-xs">View details</a></td>
                    </tr>
                `;
            });
    
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
    
            for (let i = 1; i <= data.totalPages; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="fetchOrders(${i})">${i}</a>
                    </li>
                `;
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
        });

        function downloadReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const format = document.getElementById('reportFormat').value;
            const url = `/admin/download-report?startDate=${startDate}&endDate=${endDate}&format=${format}`;

            window.location.href = url;
        }
    </script>
</body>
<%- include('./partials/adminFooter') %>
        